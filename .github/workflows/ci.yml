---
name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**/*.md"
      - "docs/**"

jobs:
  # Run all Crane-based checks
  checks:
    name: Nix Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
      - name: Run all checks (build, clippy, fmt, test, audit)
        run: nix flake check

  # Build the Nix package
  build:
    name: Build Package
    needs: checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
      - name: Build Nix package
        run: nix build

  coverage:
    name: Coverage (curator + github)
    needs: checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
      - name: Prefetch Cargo dependencies
        run: |-
          # Allow network access here so `cargo` can populate its registry/cache.
          # Later steps run with `CARGO_NET_OFFLINE=true` and a bogus proxy to
          # discourage accidental network calls during builds/tests.
          nix develop --command cargo fetch --locked
      - name: Generate coverage summary
        run: |-
          mkdir -p coverage
          # Prevent tests from accidentally making real network calls.
          # Requests to non-local hosts should fail fast.
          PROXY_URL="http://127.0.0.1:9"
          NO_PROXY_LIST="127.0.0.1,localhost,::1"

          nix develop --command env \
            HTTP_PROXY="$PROXY_URL" \
            HTTPS_PROXY="$PROXY_URL" \
            ALL_PROXY="$PROXY_URL" \
            NO_PROXY="$NO_PROXY_LIST" \
            no_proxy="$NO_PROXY_LIST" \
            CARGO_NET_OFFLINE=true \
            cargo llvm-cov -p curator --no-default-features \
            --features github --summary-only --ignore-run-fail --fail-under-lines 25 \
            | tee coverage/summary.txt
      - name: Generate lcov report
        run: |-
          PROXY_URL="http://127.0.0.1:9"
          NO_PROXY_LIST="127.0.0.1,localhost,::1"

          nix develop --command env \
            HTTP_PROXY="$PROXY_URL" \
            HTTPS_PROXY="$PROXY_URL" \
            ALL_PROXY="$PROXY_URL" \
            NO_PROXY="$NO_PROXY_LIST" \
            no_proxy="$NO_PROXY_LIST" \
            CARGO_NET_OFFLINE=true \
            cargo llvm-cov -p curator --no-default-features \
            --features github --lcov --output-path coverage/lcov.info --ignore-run-fail
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-curator-github
          path: coverage/

  # Test feature combinations (uses devShell for flexibility)
  # Uses cargo-nextest for faster parallel test execution
  # On PRs, only runs tests for changed crates and their dependents
  test-features:
    name: Test Features (${{ matrix.features || 'no features' }})
    needs: checks
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        features:
          - ""
          - "sqlite"
          - "postgres"
          - "github"
          - "gitlab"
          - "gitea"
          - "sqlite,github"
          - "postgres,github,gitlab,gitea"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-nix
      - name: Prefetch Cargo dependencies
        run: |-
          # This job runs `cargo nextest` inside a devShell (not Nix sandboxed).
          # Fetch dependencies first with normal network access, then run tests
          # in offline mode to avoid surprise network activity.
          nix develop --command cargo fetch --locked
      - name: Detect changed crates
        id: changes
        if: github.event_name == 'pull_request'
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "^crates/" | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "crates=$CHANGED" >> $GITHUB_OUTPUT
          if [ -n "$CHANGED" ]; then
            echo "Detected changes in crates: $CHANGED"
          else
            echo "No crate changes detected"
          fi
      - name: Test with features (affected only for PRs)
        run: |-
          FEATURES="${{ matrix.features }}"
          CHANGED="${{ steps.changes.outputs.crates }}"

          # Prevent tests from accidentally making real network calls.
          PROXY_URL="http://127.0.0.1:9"
          NO_PROXY_LIST="127.0.0.1,localhost,::1"

          # Build nextest filter for affected crates
          if [ -n "$CHANGED" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
            # Convert comma-separated crates to nextest filter expression
            # e.g., "curator,curator_cli" -> "rdeps(curator) | rdeps(curator_cli)"
            FILTER=$(echo "$CHANGED" | tr ',' '\n' | sed 's/.*/rdeps(&)/' | tr '\n' '|' | sed 's/|$//')
            echo "Running affected tests with filter: $FILTER"
            nix develop --command env \
              HTTP_PROXY="$PROXY_URL" \
              HTTPS_PROXY="$PROXY_URL" \
              ALL_PROXY="$PROXY_URL" \
              NO_PROXY="$NO_PROXY_LIST" \
              no_proxy="$NO_PROXY_LIST" \
              CARGO_NET_OFFLINE=true \
              cargo nextest run -p curator --no-default-features \
                --features "$FEATURES" -E "$FILTER"
          else
            # On push to main or no crate changes, run full test suite
            echo "Running full test suite"
            nix develop --command env \
              HTTP_PROXY="$PROXY_URL" \
              HTTPS_PROXY="$PROXY_URL" \
              ALL_PROXY="$PROXY_URL" \
              NO_PROXY="$NO_PROXY_LIST" \
              no_proxy="$NO_PROXY_LIST" \
              CARGO_NET_OFFLINE=true \
              cargo nextest run -p curator --no-default-features \
                --features "$FEATURES"
          fi
