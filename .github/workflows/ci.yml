---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Fast formatting check - runs first
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: cachix/cachix-action@v16
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Check formatting (treefmt)
        run: nix fmt -- --fail-on-change

  # Run all Crane-based checks
  checks:
    name: Nix Checks
    needs: format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: cachix/cachix-action@v16
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Run all checks (build, clippy, fmt, test, audit)
        run: nix flake check

  # Build the Nix package
  build:
    name: Build Package
    needs: checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: cachix/cachix-action@v16
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Build Nix package
        run: nix build

  # Test feature combinations (uses devShell for flexibility)
  test-features:
    name: Test Features (${{ matrix.features || 'no features' }})
    needs: checks
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        features:
          - ""
          - "sqlite"
          - "postgres"
          - "github"
          - "gitlab"
          - "gitea"
          - "sqlite,github"
          - "postgres,github,gitlab,gitea"
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: cachix/cachix-action@v16
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Test with features
        run: nix develop --command cargo test -p curator --no-default-features --features
          "${{ matrix.features }}"
